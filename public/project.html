<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Detail - Bid Database</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
</head>
<body>
    <nav class="main-nav">
        <div class="nav-left">
            <h1>Bid Database <span style="font-size: 0.75rem; font-weight: normal; color: #95a5a6;">v3.0</span></h1>
            <ul>
                <li><a href="index.html">Projects</a></li>
                <li><a href="compare.html">Compare</a></li>
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="bidders.html">Bidders</a></li>
            </ul>
        </div>
        <button type="button" class="edit-lock-toggle" data-edit-lock-toggle aria-pressed="false">üîí Locked</button>
    </nav>

    <div class="container">
        <div class="header">
            <div>
                <a href="index.html" style="color: #3498db; text-decoration: none;">‚Üê Back to Projects</a>
                <h2 id="projectName">Loading...</h2>
            </div>
            <div class="header-controls">
                <div class="view-tabs" role="tablist" aria-label="Project views">
                    <button id="overviewTabBtn" class="tab-toggle is-active" role="tab" aria-selected="true" aria-controls="overviewContent">Overview</button>
                    <button id="gmpTabBtn" class="tab-toggle" role="tab" aria-selected="false" aria-controls="gmpContent">GMP/EST</button>
                    <button id="bidsTabBtn" class="tab-toggle" role="tab" aria-selected="false" aria-controls="bidsContent">Bids</button>
                </div>
                <div class="action-buttons">
                    <button id="validateProjectBtn" class="btn btn-success">‚úÖ Validate</button>
                    <button id="validationHistoryBtn" class="btn btn-secondary btn-small">üìú History</button>
                    <button id="preconNotesBtn" class="btn btn-secondary btn-small btn-notes" type="button" aria-haspopup="dialog" title="View or edit estimator notes">üóíÔ∏è Pre-con Notes</button>
                    <button id="editProjectBtn" class="btn btn-secondary">‚úèÔ∏è Edit Project</button>
                    <button id="addPackageBtn" class="btn btn-secondary">+ Add Package</button>
                    <button id="uploadBidTabBtn" class="btn btn-primary">üì§ Upload Bid Tab</button>
                </div>
            </div>
        </div>

        <div id="overviewContent" class="tab-content is-active" role="tabpanel" aria-labelledby="overviewTabBtn">
            <!-- Summary Metrics -->
            <div class="metrics-grid" id="projectMetrics">
                <!-- Metrics will be loaded here -->
            </div>

            <!-- Category Breakdown -->
            <div class="table-container" style="margin-top: 2rem;">
                <h3 style="margin-bottom: 1rem;">Cost/SF by Category</h3>
                <table id="categoryTable">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>CSI Divisions</th>
                            <th>Total Cost (Median)</th>
                            <th>Median Cost/SF</th>
                            <th>Selected Cost/SF</th>
                            <th>High Cost/SF</th>
                        </tr>
                    </thead>
                    <tbody id="categoryBody">
                        <tr><td colspan="6" class="loading">Loading categories...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Charts -->
            <div style="margin-top: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; gap: 1rem; flex-wrap: wrap;">
                    <h3 style="margin: 0;">Bid Analysis Charts</h3>
                    <div style="display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; justify-content: flex-end;">
                        <label for="pieChartGrouping" style="font-weight: 600;">Pie Chart View:</label>
                        <select id="pieChartGrouping" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; min-width: 170px;">
                            <option value="division">By CSI Division</option>
                            <option value="category">By Category</option>
                        </select>
                        <label for="pieChartDataSource" style="font-weight: 600;">Data:</label>
                        <select id="pieChartDataSource" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; min-width: 150px;">
                            <option value="median">Median Bids</option>
                            <option value="low">Low Bids</option>
                            <option value="high">High Bids</option>
                            <option value="selected">Selected Bids</option>
                        </select>
                    </div>
                </div>

                <div class="chart-container" style="height: 400px; margin-bottom: 2rem;">
                    <canvas id="categoryChart"></canvas>
                </div>

                <div class="chart-container" style="height: 500px; margin-bottom: 2rem;">
                    <canvas id="packageComparisonChart"></canvas>
                </div>
            </div>

            <!-- Packages Table -->
            <div class="table-container">
                <h3 style="margin-bottom: 1rem;">Bid Packages</h3>
                <table id="packagesTable">
                    <thead>
                        <tr>
                            <th>Package</th>
                            <th>Name</th>
                            <th>Status</th>
                            <th>Selected Bidder</th>
                            <th>Selected Amount</th>
                            <th>Low Bid</th>
                            <th>Median</th>
                            <th>High Bid</th>
                            <th>Bid Spread</th>
                            <th># Bids</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="packagesBody">
                        <tr><td colspan="11" class="loading">Loading packages...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="gmpContent" class="tab-content" role="tabpanel" aria-labelledby="gmpTabBtn" aria-hidden="true">
            <div class="table-container">
                <div style="display: flex; justify-content: space-between; align-items: baseline; gap: 1rem; margin-bottom: 1rem;">
                    <div>
                        <h3 style="margin: 0;">GMP vs Bid Comparison</h3>
                        <p style="margin: 0; color: #7f8c8d; font-size: 0.95rem;">Review how each package's bids stack up against the GMP or estimate.</p>
                    </div>
                </div>
                <table id="gmpTable">
                    <thead>
                        <tr>
                            <th>Package</th>
                            <th>Name</th>
                            <th>GMP / Estimate</th>
                            <th>Low Bid</th>
                            <th>Œî Low vs GMP</th>
                            <th>%</th>
                            <th>Median Bid</th>
                            <th>Œî Median vs GMP</th>
                            <th>%</th>
                            <th>Œî Median vs Low</th>
                            <th>%</th>
                        </tr>
                    </thead>
                    <tbody id="gmpTableBody">
                        <tr><td colspan="11" class="loading">Loading GMP data...</td></tr>
                    </tbody>
                    <tfoot>
                        <tr id="gmpTotalsRow">
                            <th scope="row">Totals</th>
                            <td>‚Äî</td>
                            <td>‚Äî</td>
                            <td>‚Äî</td>
                            <td>‚Äî</td>
                            <td>‚Äî</td>
                            <td>‚Äî</td>
                            <td>‚Äî</td>
                            <td>‚Äî</td>
                            <td>‚Äî</td>
                            <td>‚Äî</td>
                        </tr>
                    </tfoot>
                </table>
                <div id="gmpTableEmpty" class="empty-state" style="display: none;">
                    <h3>No GMP data yet</h3>
                    <p>Upload a bid tab with a GMP summary or add estimated packages to compare values.</p>
                </div>
            </div>

            <div style="display: flex; justify-content: flex-end; align-items: center; gap: 0.75rem; margin: 1rem 0; flex-wrap: wrap;">
                <label for="gmpChartMode" style="font-weight: 600;">Chart Units:</label>
                <select id="gmpChartMode" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; min-width: 160px;">
                    <option value="dollar">Dollar Œî</option>
                    <option value="percent">Percent Œî</option>
                </select>
            </div>

            <div class="chart-container" style="height: 420px;">
                <canvas id="gmpDeltaChart"></canvas>
                <div id="gmpChartEmpty" class="chart-empty-state">GMP delta chart will appear when estimates and bids are available.</div>
            </div>
        </div>

        <div id="bidsContent" class="tab-content" role="tabpanel" aria-labelledby="bidsTabBtn" aria-hidden="true">
            <div class="bids-overview">
                <section class="bids-chart-card">
                    <div class="bids-card-header">
                        <h3>Bid Landscape</h3>
                        <p>Compare bidder totals by package.</p>
                    </div>
                    <div class="chart-container bids-chart">
                        <canvas id="projectBidsChart" aria-label="Grouped bids chart" role="img"></canvas>
                        <div id="projectBidsEmpty" class="chart-empty-state">Bids will appear here once they are uploaded.</div>
                    </div>
                </section>
                <section class="bids-list" id="projectBidsList">
                    <div class="loading">Loading bids...</div>
                </section>
            </div>
        </div>
    </div>

    <!-- Validate Project Modal -->
    <div id="validateProjectModal" class="modal">
        <div class="modal-content modal-narrow">
            <span class="close" onclick="closeValidateModal()">&times;</span>
            <h3>Validate Project Numbers</h3>
            <p class="modal-subtitle">Confirm the current summary values and record your validation.</p>
            <form id="validateProjectForm">
                <div class="form-group">
                    <label for="validatorInitials">Your Initials *</label>
                    <input type="text" id="validatorInitials" maxlength="6" required placeholder="e.g., JD">
                </div>
                <div class="form-group">
                    <label for="validationNotes">Notes</label>
                    <textarea id="validationNotes" rows="3" placeholder="Optional notes about this validation"></textarea>
                </div>
                <div id="validationMetricsSummary" class="validation-metrics-summary"></div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeValidateModal()">Cancel</button>
                    <button type="submit" class="btn btn-success">Validate</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Validation History Modal -->
    <div id="validationHistoryModal" class="modal">
        <div class="modal-content modal-wide">
            <span class="close" onclick="closeValidationHistoryModal()">&times;</span>
            <h3>Validation History</h3>
            <p class="modal-subtitle">Track who validated the project, when, and with which values.</p>
            <div id="validationHistoryContent" class="validation-history-list">
                <div class="loading">Loading history...</div>
            </div>
        </div>
    </div>

    <!-- Pre-con Notes Modal -->
    <div id="preconNotesModal" class="modal">
        <div class="modal-content modal-narrow">
            <span class="close" onclick="closePreconNotesModal()">&times;</span>
            <h3>Pre-con Notes</h3>
            <p class="modal-subtitle">Share estimator context for anyone referencing this project's numbers.</p>
            <form id="preconNotesForm">
                <div class="form-group">
                    <label for="preconNotesInput">Notes</label>
                    <textarea id="preconNotesInput" rows="6" placeholder="Add notes the team should consider when reviewing these numbers..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closePreconNotesModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="savePreconNotesBtn">Save Notes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Project Modal -->
    <div id="editProjectModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditProjectModal()">&times;</span>
            <h3>Edit Project</h3>
            <form id="editProjectForm">
                <div class="form-group">
                    <label for="editProjectName">Project Name *</label>
                    <input type="text" id="editProjectName" required>
                </div>
                <div class="form-group">
                    <label for="editBuildingSF">Building SF</label>
                    <input type="number" id="editBuildingSF" step="0.01">
                </div>
                <div class="form-group">
                    <label for="editProjectCounty">County</label>
                    <input type="text" id="editProjectCounty" placeholder="e.g., Travis">
                </div>
                <div class="form-group">
                    <label for="editProjectState">State</label>
                    <select id="editProjectState">
                        <option value="">Select state</option>
                        <option value="AL">Alabama</option>
                        <option value="AK">Alaska</option>
                        <option value="AZ">Arizona</option>
                        <option value="AR">Arkansas</option>
                        <option value="CA">California</option>
                        <option value="CO">Colorado</option>
                        <option value="CT">Connecticut</option>
                        <option value="DE">Delaware</option>
                        <option value="FL">Florida</option>
                        <option value="GA">Georgia</option>
                        <option value="HI">Hawaii</option>
                        <option value="ID">Idaho</option>
                        <option value="IL">Illinois</option>
                        <option value="IN">Indiana</option>
                        <option value="IA">Iowa</option>
                        <option value="KS">Kansas</option>
                        <option value="KY">Kentucky</option>
                        <option value="LA">Louisiana</option>
                        <option value="ME">Maine</option>
                        <option value="MD">Maryland</option>
                        <option value="MA">Massachusetts</option>
                        <option value="MI">Michigan</option>
                        <option value="MN">Minnesota</option>
                        <option value="MS">Mississippi</option>
                        <option value="MO">Missouri</option>
                        <option value="MT">Montana</option>
                        <option value="NE">Nebraska</option>
                        <option value="NV">Nevada</option>
                        <option value="NH">New Hampshire</option>
                        <option value="NJ">New Jersey</option>
                        <option value="NM">New Mexico</option>
                        <option value="NY">New York</option>
                        <option value="NC">North Carolina</option>
                        <option value="ND">North Dakota</option>
                        <option value="OH">Ohio</option>
                        <option value="OK">Oklahoma</option>
                        <option value="OR">Oregon</option>
                        <option value="PA">Pennsylvania</option>
                        <option value="RI">Rhode Island</option>
                        <option value="SC">South Carolina</option>
                        <option value="SD">South Dakota</option>
                        <option value="TN">Tennessee</option>
                        <option value="TX">Texas</option>
                        <option value="UT">Utah</option>
                        <option value="VT">Vermont</option>
                        <option value="VA">Virginia</option>
                        <option value="WA">Washington</option>
                        <option value="WV">West Virginia</option>
                        <option value="WI">Wisconsin</option>
                        <option value="WY">Wyoming</option>
                        <option value="DC">District of Columbia</option>
                        <option value="PR">Puerto Rico</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editProjectDate">Project Bid Date</label>
                    <input type="date" id="editProjectDate">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditProjectModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Upload Bid Tab Modal -->
    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeUploadModal()">&times;</span>
            <h3>Upload Bid Tab</h3>
            <form id="uploadForm">
                <div class="form-group">
                    <label for="bidTabFile">Select Excel File *</label>
                    <input type="file" id="bidTabFile" accept=".xlsx,.xls" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeUploadModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="uploadBtn">Upload</button>
                </div>
            </form>
            <div id="uploadProgress" style="display: none; margin-top: 1rem;">
                <p>Processing bid tab...</p>
            </div>
            <div id="uploadResult" style="display: none; margin-top: 1rem;">
                <!-- Upload result will show here -->
            </div>
        </div>
    </div>

    <!-- Add Package Modal -->
    <div id="addPackageModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAddPackageModal()">&times;</span>
            <h3>Add Estimated Package</h3>
            <form id="addPackageForm">
                <div class="form-group">
                    <label for="packageCode">Package Code *</label>
                    <input type="text" id="packageCode" placeholder="e.g., 12A" required>
                </div>
                <div class="form-group">
                    <label for="packageName">Package Name *</label>
                    <input type="text" id="packageName" placeholder="e.g., Loose Furnishings" required>
                </div>
                <div class="form-group">
                    <label for="estimatedAmount">Estimated Amount *</label>
                    <input type="number" id="estimatedAmount" step="0.01" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeAddPackageModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Package</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Package Modal -->
    <div id="editPackageModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditPackageModal()">&times;</span>
            <h3>Edit Package</h3>
            <form id="editPackageForm">
                <input type="hidden" id="editPackageId">
                <div class="form-group">
                    <label for="editPackageCode">Package Code *</label>
                    <input type="text" id="editPackageCode" required>
                </div>
                <div class="form-group">
                    <label for="editPackageName">Package Name *</label>
                    <input type="text" id="editPackageName" required>
                </div>
                <div class="form-group">
                    <label for="editSelectedAmount">Selected Amount *</label>
                    <input type="number" id="editSelectedAmount" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="editLowBid">Low Bid</label>
                    <input type="number" id="editLowBid" step="0.01">
                </div>
                <div class="form-group">
                    <label for="editMedianBid">Median Bid</label>
                    <input type="number" id="editMedianBid" step="0.01">
                </div>
                <div class="form-group">
                    <label for="editHighBid">High Bid</label>
                    <input type="number" id="editHighBid" step="0.01">
                </div>
                <div class="form-group">
                    <label for="editBidder">Selected Bidder</label>
                    <input type="text" id="editBidder" placeholder="Leave blank if still estimated">
                </div>
                <div class="form-group">
                    <label for="editStatus">Status</label>
                    <select id="editStatus">
                        <option value="estimated">Estimated</option>
                        <option value="bid">Bid</option>
                        <option value="bid-override">Bid (Override)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editNotes">Notes</label>
                    <textarea id="editNotes" rows="3"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditPackageModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Bids Modal -->
    <div id="editBidsModal" class="modal">
        <div class="modal-content modal-wide">
            <span class="close" onclick="closeEditBidsModal()">&times;</span>
            <h3 id="editBidsPackageName">Adjust Bids</h3>
            <p class="modal-subtitle">Override bid amounts and choose the selected bidder for this package. These changes will immediately update the package totals and bidder rollups.</p>
            <form id="editBidsForm">
                <input type="hidden" id="editBidsPackageId">
                <div id="editBidsList" class="edit-bids-list">
                    <div class="empty-state">Select a package to edit its bids.</div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditBidsModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveEditedBidsBtn">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script src="edit-key.js"></script>
    <script src="project.js"></script>
</body>
</html>
